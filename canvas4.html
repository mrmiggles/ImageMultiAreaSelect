<!DOCTYPE html>
<html>
	<head>
	<!-- http://jsfiddle.net/m1erickson/Spkhz/
		http://jsfiddle.net/m1erickson/7uNfW/ //drawing rectangles
		http://simonsarris.com/blog/510-making-html5-canvas-useful
	 -->
		<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
		<meta content="utf-8" http-equiv="encoding">		
 		<script src="jquery.min.js"></script> 
		 <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
		 <link rel="stylesheet" href="resize_edit.css">

		<!-- Optional theme -->
		<link rel="stylesheet" href="bootstrap/css/bootstrap-theme.min.css">

		<!-- Latest compiled and minified JavaScript -->
		<script src="bootstrap/js/bootstrap.min.js"></script>	
	</head>
	

	<body>
		<div class="row">
			<div class="col-xs-8">
				<img id="freckles" class="img-responsive" src="freckles.jpg"/>	
			</div>
			<div class="col-xs-3">
				<canvas id="preview"></canvas>				
			</div>			
		</div>
	</body>

<script type="text/javascript">

$(function(){

	var rectangles = new Object();
	var img = document.getElementById("freckles");

	/*
		<div class='drawableDiv'>
			<canvas height='imgHeight' width='imgWidth'></canvas>
		</div>
	*/
	var imgWidth = ($(img).width())/2;
	var imgHeight = ($(img).height())/2;
	var p = img.parentElement;
	var drawableCanvas = document.createElement("div");
	drawableCanvas.classList.add("drawableDiv");
	drawableCanvas.setAttribute("width", imgWidth)

	img.setAttribute("style", "display:none")

	var canvasElement = document.createElement("canvas");
	canvasElement.setAttribute("width", imgWidth);
	canvasElement.setAttribute("height", imgHeight);
	//canvasElement.classList.add("")

	p.appendChild(drawableCanvas);
	drawableCanvas.appendChild(canvasElement);
	//drawableCanvas.appendChild(img);


	var ctx = canvasElement.getContext("2d");
	var canvasImg = new Image();
		

	canvasImg.onload = function(){
		
	    // draw the image on the canvas
	    ctx.drawImage(canvasImg, 0,0, imgWidth, imgHeight);

	    // darken the image with a 50% black fill
	    //darkenImage(ctx, imgWidth, imgHeight)
		initDraw(canvasElement, canvasImg);    
	}
	canvasImg.src = img.getAttribute("src");
	
		    
});


function initDraw(canvas, canvasImg) {
	var ctx = canvas.getContext("2d");

	var cv2 = document.getElementById("preview");
	var ctx2 = cv2.getContext("2d");
	
	var canvasOffset = $(canvas).offset();
	var offsetX = canvasOffset.left;
	var offsetY = canvasOffset.top;

	var isDrawing = false;
	var startX;
	var startY;

	function handleMouseDown(e) {
	    mouseX = parseInt(e.clientX - offsetX);
	    mouseY = parseInt(e.clientY - offsetY);
	    //$("#downlog").html("Down: " + mouseX + " / " + mouseY);

	    // Put your mousedown stuff here
	    if (isDrawing) {
	        isDrawing = false;
		    ctx.clearRect(0, 0, canvas.width, canvas.height);
		    ctx.drawImage(canvasImg, 0,0, canvas.width, canvas.height);
		    //darkenImage(ctx, canvas.width, canvas.height);

		    //highlightArea(ctx, canvas, canvasImg, startX, startY, (mouseX - startX), (mouseY - startY))
			var d = ctx.getImageData(startX, startY, (mouseX - startX), (mouseY - startY));
			cv2.setAttribute("width", canvas.width)
			cv2.setAttribute("height", canvas.height)
			ctx2.putImageData(d, 0, 0);
			
			ctx.strokeRect(startX, startY, (mouseX - startX), (mouseY - startY));
	    	ctx.strokeStyle = 'red';
		
	        canvas.style.cursor = "default";
	    } else {
	        isDrawing = true;
	        startX = mouseX;
	        startY = mouseY;
	        canvas.style.cursor = "crosshair";
	        ctx.save();
	    }

	}

	$( canvas ).mousedown(function (e) {
	    handleMouseDown(e);
	});

	$( canvas ).mousemove(function( e ) {
	    mouseX = parseInt(e.clientX - offsetX);
	    mouseY = parseInt(e.clientY - offsetY);
		//$("#downlog").html("Down: " + mouseX + " / " + mouseY);
	  if(isDrawing){
	  	
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(canvasImg, 0,0, canvas.width, canvas.height);
	    ctx.strokeRect(startX, startY, mouseX - startX, mouseY - startY);
	    ctx.strokeStyle = 'red';
	  }

	});
}

function darkenImage(ctx, imgWidth, imgHeight){
    // darken the image with a 50% black fill
    ctx.save();
    ctx.globalAlpha = .50;
    ctx.fillStyle = "black";
    ctx.fillRect(0, 0, imgWidth, imgHeight);
    ctx.restore();	
}

function highlightArea(ctx, canvas, canvasImg, startX, startY, finX, finY){
    ctx.save();	        
    ctx.beginPath();
    ctx.clearRect(startX, startY, finX, finY);
    ctx.rect(startX, startY, finX, finY);
    ctx.clip();
    ctx.drawImage(canvasImg, 0, 0, canvas.width, canvas.height);
    ctx.restore();
}

</script>
</html>